{% extends "base.html" %}

{% block hero %}
<section class="hero-section slim position-relative overflow-hidden">
    <div class="bg-glow"></div>
    <div class="container">
        <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center">
            <div class="mb-3 mb-lg-0">
                <div class="eyebrow mb-2">Resultado de optimización</div>
                <h1 class="h4 text-light mb-2">Portafolio con Sharpe óptimo</h1>
                <p class="text-muted mb-0">Periodo: {{ period }} · Intervalo: {{ interval }}</p>
            </div>
            <a class="btn btn-primary btn-lg" href="{{ url_for('index') }}">Calcular otro portafolio</a>
        </div>
    </div>
</section>
{% endblock %}

{% block content %}
<div class="row g-4 mb-4">
    <div class="col-md-4">
        <div class="kpi-card gradient">
            <p class="text-muted small mb-1">Retorno esperado</p>
            <h3 class="text-light mb-0">{{ result.expected_return|pct(2) }}</h3>
        </div>
    </div>
    <div class="col-md-4">
        <div class="kpi-card gradient">
            <p class="text-muted small mb-1">Volatilidad</p>
            <h3 class="text-light mb-0">{{ result.volatility|pct(2) }}</h3>
        </div>
    </div>
    <div class="col-md-4">
        <div class="kpi-card gradient">
            <p class="text-muted small mb-1">Sharpe</p>
            <h3 class="text-light mb-0">{{ '%.2f'|format(result.sharpe) }}</h3>
        </div>
    </div>
</div>

<div class="card table-card shadow-sm">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="h5 mb-0 text-light">Pesos óptimos</h2>
            <span class="badge-soft text-primary bg-primary-subtle">Restricción sin cortos</span>
        </div>
        <div class="table-responsive">
            <table class="table align-middle table-dark table-hover">
                <thead>
                    <tr>
                        <th>Ticker</th>
                        <th class="text-end">Peso</th>
                        <th class="text-end">Aporte retorno</th>
                        <th class="text-end">Aporte varianza</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in result.rows %}
                        <tr>
                            <td><span class="badge bg-primary-soft">{{ row.ticker }}</span></td>
                            <td class="text-end">{{ row.weight|pct(2) }}</td>
                            <td class="text-end">{{ row.contrib_return|pct(2) }}</td>
                            <td class="text-end">{{ row.contrib_var|pct(2) }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="card table-card shadow-sm mt-4">
    <div class="card-body">
        <h2 class="h5 mb-3 text-light">Frontera Eficiente</h2>
        <div style="position: relative; height: 400px;">
            <canvas id="frontierChart"></canvas>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    const frontierVols = {{ result.frontier.frontier_volatilities | tojson }};
    const frontierRets = {{ result.frontier.frontier_returns | tojson }};
    const assets = {{ result.frontier.individual_assets | tojson }};
    const optimalVol = {{ result.volatility }};
    const optimalRet = {{ result.expected_return }};

    // Convertir a porcentaje
    const frontierData = frontierVols.map((vol, i) => ({
        x: vol * 100,
        y: frontierRets[i] * 100
    }));

    const assetData = assets.map(a => ({
        x: a.volatility * 100,
        y: a.return * 100,
        label: a.ticker
    }));

    const optimalPoint = [{
        x: optimalVol * 100,
        y: optimalRet * 100
    }];

    const ctx = document.getElementById('frontierChart').getContext('2d');
    new Chart(ctx, {
        type: 'scatter',
        data: {
            datasets: [
                {
                    label: 'Frontera Eficiente',
                    data: frontierData,
                    borderColor: 'rgba(99, 102, 241, 1)',
                    backgroundColor: 'rgba(99, 102, 241, 0.1)',
                    showLine: true,
                    fill: false,
                    tension: 0.3,
                    pointRadius: 0,
                    borderWidth: 2,
                    order: 2
                },
                {
                    label: 'Activos Individuales',
                    data: assetData,
                    backgroundColor: 'rgba(156, 163, 175, 0.8)',
                    borderColor: 'rgba(156, 163, 175, 1)',
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    order: 1
                },
                {
                    label: 'Portafolio Optimo',
                    data: optimalPoint,
                    backgroundColor: 'rgba(16, 185, 129, 1)',
                    borderColor: 'rgba(255, 255, 255, 1)',
                    pointRadius: 10,
                    pointHoverRadius: 12,
                    borderWidth: 2,
                    order: 0
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: {
                        color: '#e5e7eb',
                        usePointStyle: true
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const point = context.raw;
                            if (context.datasetIndex === 1) {
                                return `${assetData[context.dataIndex].label}: Vol ${point.x.toFixed(2)}%, Ret ${point.y.toFixed(2)}%`;
                            }
                            return `Vol: ${point.x.toFixed(2)}%, Ret: ${point.y.toFixed(2)}%`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Volatilidad (%)',
                        color: '#9ca3af'
                    },
                    ticks: { color: '#9ca3af' },
                    grid: { color: 'rgba(75, 85, 99, 0.3)' }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Retorno Esperado (%)',
                        color: '#9ca3af'
                    },
                    ticks: { color: '#9ca3af' },
                    grid: { color: 'rgba(75, 85, 99, 0.3)' }
                }
            }
        }
    });
})();
</script>
{% endblock %}
