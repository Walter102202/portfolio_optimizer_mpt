{% extends "base.html" %}

{% block hero %}
<section class="hero-section slim position-relative overflow-hidden">
    <div class="bg-glow"></div>
    <div class="container">
        <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center">
            <div class="mb-3 mb-lg-0">
                <div class="eyebrow mb-2">Resultado de optimización (CAPM)</div>
                <h1 class="h4 text-light mb-2">Portafolio con Sharpe óptimo</h1>
                <p class="text-muted mb-0">Datos históricos: {{ period }} · Resultados anualizados</p>
                <p class="text-muted small mb-0">Rf: {{ result.risk_free_rate|pct(2) }} · E(Rm): {{ result.market_return|pct(2) }} · Benchmark: S&P 500</p>
            </div>
            <a class="btn btn-primary btn-lg" href="{{ url_for('index') }}">Calcular otro portafolio</a>
        </div>
    </div>
</section>
{% endblock %}

{% block content %}
<div class="row g-4 mb-4">
    <div class="col-md-3">
        <div class="kpi-card gradient">
            <p class="text-muted small mb-1">Retorno esperado (anual)</p>
            <h3 class="text-light mb-0">{{ result.expected_return|pct(2) }}</h3>
        </div>
    </div>
    <div class="col-md-3">
        <div class="kpi-card gradient">
            <p class="text-muted small mb-1">Volatilidad (anual)</p>
            <h3 class="text-light mb-0">{{ result.volatility|pct(2) }}</h3>
        </div>
    </div>
    <div class="col-md-3">
        <div class="kpi-card gradient">
            <p class="text-muted small mb-1">Sharpe Ratio</p>
            <h3 class="text-light mb-0">{{ '%.2f'|format(result.sharpe) }}</h3>
        </div>
    </div>
    <div class="col-md-3">
        <div class="kpi-card">
            <p class="text-muted small mb-1">Tasa libre de riesgo</p>
            <h3 class="text-light mb-0">{{ result.risk_free_rate|pct(2) }}</h3>
            <p class="text-muted small mb-0">Treasury 10Y</p>
        </div>
    </div>
</div>

<div class="card table-card shadow-sm">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="h5 mb-0 text-light">Pesos óptimos</h2>
            <span class="badge-soft text-primary bg-primary-subtle">Restricción sin cortos</span>
        </div>
        <div class="table-responsive">
            <table class="table align-middle table-dark table-hover">
                <thead>
                    <tr>
                        <th>Ticker</th>
                        <th class="text-end">Beta</th>
                        <th class="text-end">Volatilidad</th>
                        <th class="text-end">E(R) CAPM</th>
                        <th class="text-end">Peso</th>
                        <th class="text-end">Aporte retorno</th>
                        <th class="text-end">Aporte varianza</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in result.rows %}
                        <tr>
                            <td><span class="badge bg-primary-soft">{{ row.ticker }}</span></td>
                            <td class="text-end">{{ '%.2f'|format(row.beta) }}</td>
                            <td class="text-end">{{ row.volatility|pct(2) }}</td>
                            <td class="text-end">{{ row.expected_return_capm|pct(2) }}</td>
                            <td class="text-end">{{ row.weight|pct(2) }}</td>
                            <td class="text-end">{{ row.contrib_return|pct(2) }}</td>
                            <td class="text-end">{{ row.contrib_var|pct(2) }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="card table-card shadow-sm mt-4">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="h5 mb-0 text-light">Frontera Eficiente</h2>
            <div class="d-flex align-items-center gap-3">
                <label for="rfPercentage" class="text-muted mb-0" style="white-space: nowrap;">% Deuda Rf:</label>
                <input
                    type="number"
                    id="rfPercentage"
                    class="form-control form-control-sm"
                    style="width: 100px;"
                    min="0"
                    max="100"
                    step="1"
                    value="0"
                    placeholder="0-100"
                />
                <button id="resetRf" class="btn btn-sm btn-outline-secondary">Reset</button>
            </div>
        </div>
        <div style="position: relative; height: 400px; width: 100%;">
            <canvas id="frontierChart" style="display: block; max-width: 100%; max-height: 400px;"></canvas>
        </div>
        <div id="mixedPortfolioInfo" class="mt-3 p-3 bg-dark rounded" style="display: none;">
            <h6 class="text-light mb-2">Portafolio Mixto (con deuda Rf)</h6>
            <div class="row text-muted small">
                <div class="col-md-3">
                    <strong>% en Treasury:</strong> <span id="mixedRfPercent">0%</span>
                </div>
                <div class="col-md-3">
                    <strong>% en Portafolio Óptimo:</strong> <span id="mixedOptPercent">100%</span>
                </div>
                <div class="col-md-3">
                    <strong>Retorno Esperado:</strong> <span id="mixedReturn">-</span>
                </div>
                <div class="col-md-3">
                    <strong>Volatilidad:</strong> <span id="mixedVolatility">-</span>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Simulación Monte Carlo -->
<div class="card table-card shadow-sm mt-4">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <h2 class="h5 mb-1 text-light">Simulación Monte Carlo</h2>
                <p class="text-muted small mb-0">{{ result.montecarlo.n_portfolios | default(5000) }} portafolios aleatorios generados</p>
            </div>
            <span class="badge-soft text-info bg-info-subtle">Monte Carlo</span>
        </div>
        <div style="position: relative; height: 400px; width: 100%;">
            <canvas id="montecarloChart" style="display: block; max-width: 100%; max-height: 400px;"></canvas>
        </div>
        <div class="row mt-3">
            <div class="col-md-6">
                <div class="p-3 bg-dark rounded">
                    <h6 class="text-light mb-2">Mejor Sharpe (simulado)</h6>
                    <div class="row text-muted small">
                        <div class="col-4">
                            <strong>Retorno:</strong> {{ (result.montecarlo.best_sharpe.return * 100) | round(2) }}%
                        </div>
                        <div class="col-4">
                            <strong>Volatilidad:</strong> {{ (result.montecarlo.best_sharpe.volatility * 100) | round(2) }}%
                        </div>
                        <div class="col-4">
                            <strong>Sharpe:</strong> {{ result.montecarlo.best_sharpe.sharpe | round(2) }}
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="p-3 bg-dark rounded">
                    <h6 class="text-light mb-2">Mínima Volatilidad (simulada)</h6>
                    <div class="row text-muted small">
                        <div class="col-4">
                            <strong>Retorno:</strong> {{ (result.montecarlo.min_vol.return * 100) | round(2) }}%
                        </div>
                        <div class="col-4">
                            <strong>Volatilidad:</strong> {{ (result.montecarlo.min_vol.volatility * 100) | round(2) }}%
                        </div>
                        <div class="col-4">
                            <strong>Sharpe:</strong> {{ result.montecarlo.min_vol.sharpe | round(2) }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Esperar a que tanto el DOM como Chart.js estén listos
window.addEventListener('load', function() {
    console.log('=== INICIO DEBUG GRÁFICO ===');
    console.log('DOM completamente cargado');
    console.log('Chart.js disponible:', typeof Chart !== 'undefined');

    try {
        const frontierVols = {{ result.frontier.frontier_volatilities | tojson }};
        const frontierRets = {{ result.frontier.frontier_returns | tojson }};
        const assets = {{ result.frontier.individual_assets | tojson }};
        const optimalVol = {{ result.volatility }};
        const optimalRet = {{ result.expected_return }};
        const riskFreeRate = {{ result.risk_free_rate }};
        const sharpeRatio = {{ result.sharpe }};

        console.log('Datos del backend:', {
            frontierVols: Array.isArray(frontierVols) ? frontierVols.length + ' puntos' : frontierVols,
            frontierRets: Array.isArray(frontierRets) ? frontierRets.length + ' puntos' : frontierRets,
            assets: Array.isArray(assets) ? assets.length + ' activos' : assets,
            optimalVol: optimalVol,
            optimalRet: optimalRet,
            riskFreeRate: riskFreeRate,
            sharpeRatio: sharpeRatio
        });

        // Verificar que Chart.js esté disponible
        if (typeof Chart === 'undefined') {
            console.error('ERROR: Chart.js no está cargado');
            alert('Error: Chart.js no pudo cargarse. Por favor recarga la página.');
            return;
        }
        console.log('✓ Chart.js está disponible');

        // Convertir a porcentaje
        const frontierData = frontierVols.map((vol, i) => ({
            x: vol * 100,
            y: frontierRets[i] * 100
        }));

        const assetData = assets.map(a => ({
            x: a.volatility * 100,
            y: a.return * 100,
            label: a.ticker
        }));

        const optimalPoint = [{
            x: optimalVol * 100,
            y: optimalRet * 100
        }];

        const riskFreePoint = [{
            x: 0,
            y: riskFreeRate * 100
        }];

        // Capital Market Line (CML)
        const maxVol = Math.max(...frontierVols, optimalVol) * 100 * 1.2;
        const cmlData = [
            { x: 0, y: riskFreeRate * 100 },
            { x: maxVol, y: riskFreeRate * 100 + sharpeRatio * maxVol }
        ];

        const canvas = document.getElementById('frontierChart');
        console.log('Canvas element:', canvas);

        if (!canvas) {
            console.error('ERROR: Canvas frontierChart no encontrado en el DOM');
            alert('Error: No se encontró el elemento canvas para el gráfico');
            return;
        }
        console.log('✓ Canvas encontrado');

        const ctx = canvas.getContext('2d');
        console.log('Context 2D:', ctx);

        if (!ctx) {
            console.error('ERROR: No se pudo obtener el contexto 2D del canvas');
            return;
        }
        console.log('✓ Contexto 2D obtenido');

        console.log('Creando instancia de Chart...');

        const chart = new Chart(ctx, {
        type: 'scatter',
        data: {
            datasets: [
                {
                    label: 'Línea de Mercado (CML)',
                    data: cmlData,
                    borderColor: 'rgba(251, 191, 36, 1)',
                    backgroundColor: 'rgba(251, 191, 36, 0.1)',
                    showLine: true,
                    fill: false,
                    tension: 0,
                    pointRadius: 0,
                    borderWidth: 2,
                    borderDash: [5, 5],
                    order: 4
                },
                {
                    label: 'Frontera Eficiente',
                    data: frontierData,
                    borderColor: 'rgba(99, 102, 241, 1)',
                    backgroundColor: 'rgba(99, 102, 241, 0.1)',
                    showLine: true,
                    fill: false,
                    tension: 0.3,
                    pointRadius: 0,
                    borderWidth: 2,
                    order: 3
                },
                {
                    label: 'Activos Individuales',
                    data: assetData,
                    backgroundColor: 'rgba(156, 163, 175, 0.8)',
                    borderColor: 'rgba(156, 163, 175, 1)',
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    order: 2
                },
                {
                    label: 'Tasa Libre de Riesgo',
                    data: riskFreePoint,
                    backgroundColor: 'rgba(251, 191, 36, 1)',
                    borderColor: 'rgba(255, 255, 255, 1)',
                    pointRadius: 8,
                    pointHoverRadius: 10,
                    borderWidth: 2,
                    pointStyle: 'rect',
                    order: 1
                },
                {
                    label: 'Portafolio Óptimo (Tangente)',
                    data: optimalPoint,
                    backgroundColor: 'rgba(16, 185, 129, 1)',
                    borderColor: 'rgba(255, 255, 255, 1)',
                    pointRadius: 10,
                    pointHoverRadius: 12,
                    borderWidth: 2,
                    order: 0
                },
                {
                    label: 'Portafolio Mixto (con Rf)',
                    data: [],
                    backgroundColor: 'rgba(249, 115, 22, 1)',
                    borderColor: 'rgba(255, 255, 255, 1)',
                    pointRadius: 10,
                    pointHoverRadius: 12,
                    borderWidth: 2,
                    pointStyle: 'triangle',
                    order: 0
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: {
                        color: '#e5e7eb',
                        usePointStyle: true,
                        filter: function(item) {
                            // Ocultar la leyenda del portafolio mixto inicialmente
                            if (item.text === 'Portafolio Mixto (con Rf)') {
                                return false;
                            }
                            return true;
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const point = context.raw;
                            const datasetLabel = context.dataset.label;

                            if (datasetLabel === 'Activos Individuales') {
                                return `${assetData[context.dataIndex].label}: Vol ${point.x.toFixed(2)}%, Ret ${point.y.toFixed(2)}%`;
                            } else if (datasetLabel === 'Tasa Libre de Riesgo') {
                                return `Rf: ${point.y.toFixed(2)}% (sin riesgo)`;
                            } else if (datasetLabel === 'Portafolio Óptimo (Tangente)') {
                                return `Óptimo: Vol ${point.x.toFixed(2)}%, Ret ${point.y.toFixed(2)}%, Sharpe ${sharpeRatio.toFixed(2)}`;
                            } else if (datasetLabel === 'Portafolio Mixto (con Rf)') {
                                return `Mixto: Vol ${point.x.toFixed(2)}%, Ret ${point.y.toFixed(2)}%`;
                            }
                            return `Vol: ${point.x.toFixed(2)}%, Ret: ${point.y.toFixed(2)}%`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Volatilidad Anual (%)',
                        color: '#9ca3af'
                    },
                    ticks: { color: '#9ca3af' },
                    grid: { color: 'rgba(75, 85, 99, 0.3)' }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Retorno Esperado Anual (%)',
                        color: '#9ca3af'
                    },
                    ticks: { color: '#9ca3af' },
                    grid: { color: 'rgba(75, 85, 99, 0.3)' }
                }
            }
        }
    });

    // Función para calcular y actualizar el portafolio mixto
    function updateMixedPortfolio(rfPercentage) {
        const rfPercent = parseFloat(rfPercentage) / 100;
        const optPercent = 1 - rfPercent;

        if (rfPercent === 0) {
            // Ocultar el punto y la info
            chart.data.datasets[5].data = [];
            document.getElementById('mixedPortfolioInfo').style.display = 'none';

            // Actualizar filtro de leyenda para ocultar el portafolio mixto
            chart.options.plugins.legend.labels.filter = function(item) {
                if (item.text === 'Portafolio Mixto (con Rf)') {
                    return false;
                }
                return true;
            };
        } else {
            // Calcular portafolio mixto
            const mixedReturn = rfPercent * riskFreeRate + optPercent * optimalRet;
            const mixedVol = optPercent * optimalVol;

            // Actualizar el punto en el gráfico
            chart.data.datasets[5].data = [{
                x: mixedVol * 100,
                y: mixedReturn * 100
            }];

            // Mostrar información
            document.getElementById('mixedRfPercent').textContent = (rfPercent * 100).toFixed(1) + '%';
            document.getElementById('mixedOptPercent').textContent = (optPercent * 100).toFixed(1) + '%';
            document.getElementById('mixedReturn').textContent = (mixedReturn * 100).toFixed(2) + '%';
            document.getElementById('mixedVolatility').textContent = (mixedVol * 100).toFixed(2) + '%';
            document.getElementById('mixedPortfolioInfo').style.display = 'block';

            // Actualizar filtro de leyenda para mostrar el portafolio mixto
            chart.options.plugins.legend.labels.filter = function(item) {
                return true;  // Mostrar todos los elementos
            };
        }

        chart.update('none');  // Actualizar sin animación para mejor rendimiento
    }

    // Event listeners
    const rfInput = document.getElementById('rfPercentage');
    const resetButton = document.getElementById('resetRf');

    rfInput.addEventListener('input', function(e) {
        const value = parseFloat(e.target.value);
        if (!isNaN(value) && value >= 0 && value <= 100) {
            updateMixedPortfolio(value);
        }
    });

    resetButton.addEventListener('click', function() {
        rfInput.value = 0;
        updateMixedPortfolio(0);
    });

        console.log('✓ GRÁFICO CREADO EXITOSAMENTE');
        console.log('=== FIN DEBUG GRÁFICO ===');

    } catch (error) {
        console.error('❌ ERROR FATAL al crear el gráfico:', error);
        console.error('Mensaje:', error.message);
        console.error('Stack trace:', error.stack);
        alert('Error al crear el gráfico: ' + error.message + '\nRevisa la consola para más detalles.');
    }

    // --- Monte Carlo Chart ---
    try {
        const mcPortfolios = {{ result.montecarlo.portfolios | tojson }};
        const mcBestSharpe = {{ result.montecarlo.best_sharpe | tojson }};
        const mcMinVol = {{ result.montecarlo.min_vol | tojson }};
        const mcOptimalVol = {{ result.volatility }};
        const mcOptimalRet = {{ result.expected_return }};

        // Scatter data coloreado por Sharpe ratio
        const mcData = mcPortfolios.map(p => ({
            x: p.volatility * 100,
            y: p.return * 100,
            sharpe: p.sharpe
        }));

        // Calcular rango de Sharpe para colorear
        const sharpes = mcPortfolios.map(p => p.sharpe);
        const minSharpe = Math.min(...sharpes);
        const maxSharpe = Math.max(...sharpes);
        const sharpeRange = maxSharpe - minSharpe || 1;

        // Asignar colores según Sharpe (rojo bajo → amarillo medio → verde alto)
        function sharpeColor(sharpe) {
            const t = (sharpe - minSharpe) / sharpeRange;
            const r = Math.round(255 * (1 - t));
            const g = Math.round(255 * t);
            return `rgba(${r}, ${g}, 80, 0.35)`;
        }

        const mcColors = mcPortfolios.map(p => sharpeColor(p.sharpe));

        const mcCanvas = document.getElementById('montecarloChart');
        const mcCtx = mcCanvas.getContext('2d');

        new Chart(mcCtx, {
            type: 'scatter',
            data: {
                datasets: [
                    {
                        label: 'Portafolios simulados',
                        data: mcData,
                        backgroundColor: mcColors,
                        borderColor: mcColors,
                        pointRadius: 2,
                        pointHoverRadius: 4,
                        order: 3
                    },
                    {
                        label: 'Portafolio Óptimo (SLSQP)',
                        data: [{ x: mcOptimalVol * 100, y: mcOptimalRet * 100 }],
                        backgroundColor: 'rgba(16, 185, 129, 1)',
                        borderColor: 'rgba(255, 255, 255, 1)',
                        pointRadius: 10,
                        pointHoverRadius: 12,
                        borderWidth: 2,
                        order: 0
                    },
                    {
                        label: 'Mejor Sharpe (MC)',
                        data: [{ x: mcBestSharpe.volatility * 100, y: mcBestSharpe.return * 100 }],
                        backgroundColor: 'rgba(251, 191, 36, 1)',
                        borderColor: 'rgba(255, 255, 255, 1)',
                        pointRadius: 8,
                        pointHoverRadius: 10,
                        borderWidth: 2,
                        pointStyle: 'star',
                        order: 1
                    },
                    {
                        label: 'Mínima Volatilidad (MC)',
                        data: [{ x: mcMinVol.volatility * 100, y: mcMinVol.return * 100 }],
                        backgroundColor: 'rgba(99, 102, 241, 1)',
                        borderColor: 'rgba(255, 255, 255, 1)',
                        pointRadius: 8,
                        pointHoverRadius: 10,
                        borderWidth: 2,
                        pointStyle: 'rectRot',
                        order: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            color: '#e5e7eb',
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const point = context.raw;
                                const dsLabel = context.dataset.label;
                                if (dsLabel === 'Portafolios simulados') {
                                    return `Vol: ${point.x.toFixed(2)}%, Ret: ${point.y.toFixed(2)}%, Sharpe: ${point.sharpe.toFixed(2)}`;
                                }
                                return `${dsLabel}: Vol ${point.x.toFixed(2)}%, Ret ${point.y.toFixed(2)}%`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Volatilidad Anual (%)',
                            color: '#9ca3af'
                        },
                        ticks: { color: '#9ca3af' },
                        grid: { color: 'rgba(75, 85, 99, 0.3)' }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Retorno Esperado Anual (%)',
                            color: '#9ca3af'
                        },
                        ticks: { color: '#9ca3af' },
                        grid: { color: 'rgba(75, 85, 99, 0.3)' }
                    }
                }
            }
        });

        console.log('✓ GRÁFICO MONTE CARLO CREADO EXITOSAMENTE');
    } catch (mcError) {
        console.error('Error al crear gráfico Monte Carlo:', mcError);
    }
});
</script>
{% endblock %}
